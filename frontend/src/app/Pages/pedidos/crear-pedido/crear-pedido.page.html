<ion-header>
  <ion-toolbar class="header-blend">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title class="brand-min">Crear Pedido</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="crear-pedido">

  <div class="wrap">
    <!-- Columna izquierda: Buscar y agregar -->
    <section class="panel buscador-panel">
      <header class="panel-head">
        <h2>Busca y agrega</h2>
        <p class="hint">Escribe el nombre del producto o usa una categoría. Toca “+” para sumar.</p>
      </header>

      <!-- Search -->
      <div class="search-row">
        <ion-searchbar
          placeholder="Ej. pastel, cupcake, chocolate..."
          [(ngModel)]="terminoBusqueda"
          (ionInput)="filtrarProductos()"
          animated="true">
        </ion-searchbar>

        <ion-button fill="clear" class="btn-clear" (click)="limpiarBusqueda()" [disabled]="!terminoBusqueda.trim()">
          Limpiar
        </ion-button>
      </div>

      <!-- Chips de categoría -->
      <div class="chips" *ngIf="categorias.length">
        <ion-chip class="chip" [outline]="!categoriaSeleccionada" (click)="seleccionarCategoria(null)">
          <ion-label>Todas</ion-label>
        </ion-chip>
        <ion-chip
          class="chip"
          *ngFor="let cat of categorias"
          [outline]="categoriaSeleccionada !== cat.id"
          (click)="seleccionarCategoria(cat.id)">
          <ion-label>{{ cat.nombre }}</ion-label>
        </ion-chip>
      </div>

      <!-- Estado vacío (se oculta si mostramos Recomendados) -->
      <div class="estado-vacio" *ngIf="!terminoBusqueda.trim() && !categoriaSeleccionada && !mostrandoDefault">
        <p>Empieza buscando o elige una categoría.</p>
        <small>Tip: escribe al menos 3 letras para mejores resultados.</small>
      </div>

      <!-- Subtítulo de Recomendados -->
      <h3 class="subhead" *ngIf="mostrandoDefault && productosFiltrados.length">
        Recomendados
      </h3>

      <!-- Resultados -->
      <div class="lista-filtrada" *ngIf="productosFiltrados.length > 0">
        <ion-list lines="none">
          <ion-item class="producto-item" *ngFor="let producto of productosFiltrados">
            <ion-thumbnail slot="start" class="thumb">
              <img [src]="producto.imagenUrl || 'assets/logo.png'" alt="Imagen de {{ producto.nombre }}" />
            </ion-thumbnail>

            <ion-label class="info">
              <h3>{{ producto.nombre }}</h3>
              <p class="precio">Precio: ${{ producto.precio }}</p>
            </ion-label>

            <!-- Controles de cantidad compactos -->
            <div class="qty">
              <ion-button fill="clear" size="small" class="btn-qty" (click)="decCantidad(producto)">−</ion-button>
              <ion-input
                class="input-qty"
                type="number"
                inputmode="numeric"
                min="0"
                [(ngModel)]="producto.cantidad"
                (ionInput)="actualizarSeleccion(producto)"
                placeholder="0">
              </ion-input>
              <ion-button fill="solid" size="small" class="btn-add" (click)="incCantidad(producto)">+</ion-button>
            </div>
          </ion-item>
        </ion-list>
      </div>

      <!-- Ver más (paginación de recomendados) -->
      <div class="ver-mas" *ngIf="hayMasDefault">
        <ion-button fill="outline" (click)="verMasDefault()">Ver más</ion-button>
      </div>
    </section>

    <!-- Columna derecha: Tu pedido -->
    <aside class="panel pedido-panel">
      <header class="panel-head sticky">
        <h2>Tu pedido</h2>
        <p class="hint">Revisa cantidades, programa entrega y confirma.</p>
      </header>

      <!-- Seleccionados -->
      <div class="lista-seleccionados" *ngIf="productosSeleccionados.length > 0; else sinSel">
        <ion-list lines="none">
          <ion-item class="seleccionado-item" *ngFor="let producto of productosSeleccionados">
            <ion-thumbnail slot="start" class="thumb">
              <img [src]="producto.imagenUrl || 'assets/logo.png'" alt="Imagen de {{ producto.nombre }}" />
            </ion-thumbnail>

            <ion-label>
              <h3>{{ producto.nombre }}</h3>
              <div class="detalle-line">
                <span>Cant: <b>{{ producto.cantidad }}</b></span>
                <span>Precio: ${{ producto.precio }}</span>
                <span>Subtotal: <b>${{ (producto.precio * producto.cantidad) || 0 }}</b></span>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>
      <ng-template #sinSel>
        <div class="estado-vacio soft">
          <p>Aún no has agregado productos.</p>
          <small>Usa el buscador o las categorías para sumar artículos.</small>
        </div>
      </ng-template>

      <!-- Fecha y HORARIO con slots -->
      <div class="entrega">
        <!-- 1) Selección de DÍA (modal compacto) -->
        <div class="fecha-row">
          <div class="fecha-label">
            <ion-icon name="calendar-outline"></ion-icon>
            <span>Fecha de entrega</span>
          </div>

          <!-- Botón que abre el datetime en un modal -->
          <ion-datetime-button datetime="fechaEntrega" class="fecha-btn"></ion-datetime-button>

          <!-- Modal con el calendario -->
          <ion-modal keepContentsMounted="true">
            <ng-template>
              <ion-datetime
                id="fechaEntrega"
                presentation="date"
                (ionChange)="onDateChange($event)"
                [isDateEnabled]="isDayEnabled"
              ></ion-datetime>
            </ng-template>
          </ion-modal>
        </div>

        <!-- 2) Slots disponibles para el día seleccionado -->
        <div class="slots" *ngIf="selectedDate">
          <div class="slots-head sticky">
            <h4>Horarios disponibles</h4>
            <ion-note color="medium" class="slots-hint">
              08:00–20:00, cada 30 min • mínimo 24 h de anticipación
            </ion-note>
          </div>

          <div class="slots-grid">
            <button
              class="slot-pill"
              *ngFor="let s of timeSlots"
              [class.selected]="selectedTime === s.value"
              [class.disabled]="s.disabled"
              [disabled]="s.disabled"
              (click)="onPickSlot(s)"
              type="button"
            >
              <ion-icon *ngIf="selectedTime === s.value" name="checkmark-circle-outline"></ion-icon>
              <span>{{ s.label }}</span>
            </button>
          </div>

          <div class="slots-legend">
            <span class="legend-item"><i class="dot available"></i> Disponible</span>
            <span class="legend-item"><i class="dot selected"></i> Seleccionado</span>
            <span class="legend-item"><i class="dot disabled"></i> Ocupado</span>
          </div>

          <ion-note color="warning" *ngIf="allSlotsDisabled()" class="msg-alerta">
            No hay horarios disponibles para esta fecha. Prueba con otro día.
          </ion-note>
        </div>

        <!-- Mensajes y resumen -->
        <ion-note color="danger" *ngIf="errorEntrega" class="msg-error">
          {{ errorEntrega }}
        </ion-note>

        <div class="entrega-visual" *ngIf="fechaEntregaVisual && !errorEntrega">
          <span class="etiqueta">Entrega programada:</span>
          <span class="valor">{{ fechaEntregaVisual }}</span>
        </div>
      </div>

      <!-- Notas -->
      <ion-item lines="none" class="notas-item">
        <ion-label>Notas adicionales</ion-label>
        <ion-textarea
          [(ngModel)]="notas"
          maxlength="200"
          counter="true"
          placeholder="Sabores, tamaño, dedicatoria, etc.">
        </ion-textarea>
      </ion-item>

      <!-- Total + CTA (desktop) -->
      <div class="cta-desktop">
        <div class="total">
          <span>Total estimado</span>
          <b>${{ total }}</b>
        </div>
        <ion-button size="large" (click)="crearPedido()" [disabled]="!puedeEnviar()" class="btn-confirmar">
          Confirmar Pedido
        </ion-button>
      </div>
    </aside>
  </div>

  <!-- Total + CTA (móvil) -->
  <div class="resumen-fijo">
    <div class="total">
      <span>Total estimado</span>
      <b>${{ total }}</b>
    </div>
    <ion-button size="large" (click)="crearPedido()" [disabled]="!puedeEnviar()" class="btn-confirmar">
      Confirmar Pedido
    </ion-button>
  </div>

</ion-content>
