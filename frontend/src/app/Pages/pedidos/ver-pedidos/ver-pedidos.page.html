<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Gesti√≥n de Pedidos</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding pedidos-content">

  <!-- Filtros -->
  <div class="filtros">
    <div class="filtros-head">
      <h4>Filtros</h4>
      <div class="resumen">
        <span class="contador">{{ pedidosFiltrados.length }} resultado(s)</span>
        <ion-button fill="clear" size="small"
                    (click)="limpiarFiltros()" [disabled]="!tieneFiltrosActivos()">Limpiar</ion-button>
      </div>
    </div>

    <!-- Estado -->
    <ion-segment class="seg-estados"
                 [(ngModel)]="filtroEstado" (ionChange)="aplicarFiltros()">
      <ion-segment-button value="">Todos</ion-segment-button>
      <ion-segment-button value="pendiente">Pendiente</ion-segment-button>
      <ion-segment-button value="aceptado">Aceptado</ion-segment-button>
      <ion-segment-button value="rechazado">Rechazado</ion-segment-button>
      <ion-segment-button value="entregado">Entregado</ion-segment-button>
    </ion-segment>

    <!-- Mes/A√±o + Atajos -->
    <div class="fila-fecha">
      <ion-item lines="none">
        <ion-label>Mes</ion-label>
        <ion-datetime-button datetime="mesFiltro"></ion-datetime-button>
      </ion-item>

      <ion-modal [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime id="mesFiltro" presentation="month-year"
                        (ionChange)="onMesChange($event)"></ion-datetime>
        </ng-template>
      </ion-modal>

      <div class="rapidos">
        <ion-chip (click)="setRango('hoy')"><ion-label>Hoy</ion-label></ion-chip>
        <ion-chip (click)="setRango('7d')"><ion-label>√ölt. 7 d√≠as</ion-label></ion-chip>
        <ion-chip (click)="setRango('mes')"><ion-label>Este mes</ion-label></ion-chip>
        <ion-chip (click)="setRango('30d')"><ion-label>√ölt. 30 d√≠as</ion-label></ion-chip>
      </div>
    </div>

    <!-- Orden -->
    <ion-segment class="seg-orden"
                 [(ngModel)]="orden" (ionChange)="aplicarFiltros()">
      <ion-segment-button value="recientes">Recientes</ion-segment-button>
      <ion-segment-button value="antiguos">Antiguos</ion-segment-button>
    </ion-segment>

    <!-- Chips activos -->
    <div class="chips-activos" *ngIf="tieneFiltrosActivos()">
      <ion-chip *ngIf="filtroEstado"
                (click)="filtroEstado=''; aplicarFiltros()">
        <ion-label>Estado: {{filtroEstado}}</ion-label>
      </ion-chip>

      <ion-chip *ngIf="filtroMes"
                (click)="filtroMes=''; aplicarFiltros()">
        <ion-label>Mes: {{filtroMes}}</ion-label>
      </ion-chip>

      <ion-chip *ngIf="fechaDesde || fechaHasta"
                (click)="borrarRango(); aplicarFiltros()">
        <ion-label>
          Rango:
          <ng-container *ngIf="fechaDesde">{{ fechaDesde | date:'d MMM y' }}</ng-container>
          <ng-container *ngIf="fechaHasta"> ‚Äì {{ fechaHasta | date:'d MMM y' }}</ng-container>
        </ion-label>
      </ion-chip>
    </div>
  </div>

  <!-- Lista -->
  <div class="lista-pedidos" *ngIf="pedidosFiltrados.length > 0; else sinPedidos">
    <div class="tarjeta-pedido" *ngFor="let pedido of pedidosFiltrados">
      <div class="pedido-info">
        <h3>üßæ Pedido ‚Ä¢ {{ pedido.fecha_pedido | date:'EEE d MMM y, HH:mm':'America/Mexico_City' }}</h3>

        <p><strong>Cliente:</strong> {{ pedido.users_permissions_user?.username }}</p>
        <p><strong>Entrega:</strong> {{ pedido.fecha_entrega | date:'EEE d MMM y, HH:mm':'America/Mexico_City' }}</p>
        <p class="estado-row">
          <strong>Estado:</strong>
          <span class="chip" [ngClass]="pedido.estado">{{ pedido.estado }}</span>
        </p>
        <p><strong>Total:</strong> ${{ pedido.total }}</p>
      </div>

      <div class="pedido-acciones">
        <ion-button class="btn-detalle" size="small" (click)="verDetalle(pedido.documentId)">
          Ver detalles
        </ion-button>
      </div>
    </div>
  </div>

  <ng-template #sinPedidos>
    <div class="mensaje-vacio">
      <ion-text color="medium">
        <p class="ion-text-center">No hay pedidos que coincidan con los filtros.</p>
      </ion-text>
    </div>
  </ng-template>
</ion-content>
