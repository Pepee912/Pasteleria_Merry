<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/mis-pedidos"></ion-back-button>
    </ion-buttons>
    <ion-title>Ticket de Pedido</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding ticket-content">
  <ng-container *ngIf="pedido; else cargando">
    <div class="ticket-wrapper">
      <!-- Encabezado -->
      <div class="ticket-header">
        <img src="assets/logo.png" alt="Logo" class="ticket-logo" />
        <div class="ticket-header-text">
          <h2>Pastelería Merry</h2>
          <p class="ticket-slogan">Dulces momentos, mejor diseño</p>
        </div>
      </div>

      <div class="ticket-code">
        <span class="label">Código</span>
        <span class="value mono">{{ pedido.documentId }}</span>
      </div>

      <!-- Datos del pedido -->
      <div class="ticket-card">
        <h3>Datos del pedido</h3>
        <div class="info-grid">
          <div>
            <span class="label">Cliente</span>
            <span class="value">{{ pedido.users_permissions_user?.username || '—' }}</span>
          </div>
          <div>
            <span class="label">Email</span>
            <span class="value">{{ pedido.users_permissions_user?.email || '—' }}</span>
          </div>
          <div>
            <span class="label">Estado</span>
            <span class="chip" [ngClass]="pedido.estado">{{ pedido.estado | titlecase }}</span>
          </div>
          <div>
            <span class="label">Creado</span>
            <span class="value">{{ formatearFecha(pedido.fecha_pedido) }}</span>
          </div>
          <div>
            <span class="label">Entrega</span>
            <span class="value">{{ formatearFecha(pedido.fecha_entrega) }}</span>
          </div>
          <div class="notas" *ngIf="pedido.notas">
            <span class="label">Notas</span>
            <span class="value">{{ pedido.notas }}</span>
          </div>
        </div>
      </div>

      <!-- Productos -->
      <div class="ticket-card">
        <h3>Productos</h3>
        <div class="table">
          <div class="thead">
            <div class="th qty">Cant.</div>
            <div class="th name">Producto</div>
            <div class="th price">Subtotal</div>
          </div>
          <div class="tbody">
            <div class="tr" *ngFor="let d of pedido.detalles_pedidos">
              <div class="td qty">{{ d.cantidad }}</div>
              <div class="td name">{{ d.producto?.nombre || '—' }}</div>
              <div class="td price">{{ formatearMoneda(d.subtotal) }}</div>
            </div>
          </div>
        </div>

        <div class="total-row">
          <span>Total</span>
          <span class="total-amount">{{ formatearMoneda(pedido.total ?? totalCalculado) }}</span>
        </div>
      </div>

      <!-- QR + Acciones -->
      <div class="ticket-actions">
        <div class="qr-card">
          <p class="qr-text">Escanea para validar tu pedido</p>
          <img *ngIf="qrCodeDataUrl" [src]="qrCodeDataUrl" alt="QR Ticket" />
          <p class="qr-hint mono">{{ pedido.documentId }}</p>
        </div>

        <div class="buttons">
          <ion-button expand="block" color="success" (click)="descargarPDF()">
            Descargar PDF
          </ion-button>
          <ion-button expand="block" fill="outline" color="primary" (click)="imprimirVista()">
            Imprimir
          </ion-button>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #cargando>
    <div class="skeleton">
      <ion-skeleton-text animated style="width: 60%; height: 24px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 140px; margin-top: 12px;"></ion-skeleton-text>
      <ion-skeleton-text animated style="width: 100%; height: 200px; margin-top: 12px;"></ion-skeleton-text>
    </div>
  </ng-template>
</ion-content>
