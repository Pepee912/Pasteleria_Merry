<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Historial de Ventas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding ver-ventas-content">

  <!-- Filtros -->
  <div class="filtros">
    <div class="filtros-head">
      <h4>Filtros</h4>
      <div class="resumen">
        <span class="contador">{{ ventasFiltradas.length }} resultado(s)</span>
        <ion-button fill="clear" size="small"
                    (click)="limpiarFiltros()" [disabled]="!tieneFiltrosActivos()">Limpiar</ion-button>
      </div>
    </div>

    <!-- Mes/A√±o + atajos -->
    <div class="fila-fecha">
      <ion-item lines="none">
        <ion-label>Mes</ion-label>
        <ion-datetime-button datetime="mesFiltro"></ion-datetime-button>
      </ion-item>

      <ion-modal [keepContentsMounted]="true">
        <ng-template>
          <ion-datetime id="mesFiltro" presentation="month-year"
                        (ionChange)="onMesChange($event)"></ion-datetime>
        </ng-template>
      </ion-modal>

      <div class="rapidos">
        <ion-chip (click)="setRango('hoy')"><ion-label>Hoy</ion-label></ion-chip>
        <ion-chip (click)="setRango('7d')"><ion-label>√ölt. 7 d√≠as</ion-label></ion-chip>
        <ion-chip (click)="setRango('mes')"><ion-label>Este mes</ion-label></ion-chip>
        <ion-chip (click)="setRango('30d')"><ion-label>√ölt. 30 d√≠as</ion-label></ion-chip>
      </div>
    </div>

    <!-- Orden -->
    <ion-segment class="seg-orden"
                 [(ngModel)]="orden" (ionChange)="aplicarFiltros()">
      <ion-segment-button value="recientes">Recientes</ion-segment-button>
      <ion-segment-button value="antiguos">Antiguos</ion-segment-button>
    </ion-segment>

    <!-- Chips activos -->
    <div class="chips-activos" *ngIf="tieneFiltrosActivos()">
      <ion-chip *ngIf="filtroMes"
                (click)="filtroMes=''; aplicarFiltros()">
        <ion-label>Mes: {{filtroMes}}</ion-label>
      </ion-chip>

      <ion-chip *ngIf="fechaDesde || fechaHasta"
                (click)="borrarRango(); aplicarFiltros()">
        <ion-label>
          Rango:
          <ng-container *ngIf="fechaDesde">{{ fechaDesde | date:'d MMM y' }}</ng-container>
          <ng-container *ngIf="fechaHasta"> ‚Äì {{ fechaHasta | date:'d MMM y' }}</ng-container>
        </ion-label>
      </ion-chip>

    </div>
  </div>

  <!-- Lista de ventas -->
  <div *ngIf="ventasFiltradas.length > 0; else sinVentas">
    <div class="tarjeta-venta" *ngFor="let v of ventasFiltradas">
      <div class="venta-info">
        <h3>üßæ Venta ‚Ä¢ {{ v.fecha_venta | date:'EEE d MMM y, HH:mm':'America/Mexico_City' }}</h3>

        <p><strong>Cliente:</strong> {{ v.pedido?.users_permissions_user?.username || 'Desconocido' }}</p>
        <p class="estado-row">
          <strong>Estado:</strong>
          <span class="chip entregado">entregado</span>
        </p>
        <p><strong>Total:</strong> ${{ v.total }}</p>

        <!-- Resumen de productos (desde el pedido) -->
        <div class="productos-resumen" *ngIf="$any(v.pedido)?.detalles_pedidos?.length">
          <ion-chip outline="true"
                    *ngFor="let d of ($any(v.pedido).detalles_pedidos || []) | slice:0:3">
            <ion-label>{{ $any(d).producto?.nombre || 'Producto' }}</ion-label>
            <ion-badge>{{ $any(d).cantidad }}x</ion-badge>
          </ion-chip>

          <button class="link-ver-mas"
                  *ngIf="$any(v.pedido).detalles_pedidos.length > 3"
                  (click)="toggleVerMas(v)">
            + {{ $any(v.pedido).detalles_pedidos.length - 3 }} m√°s
          </button>
        </div>

        <!-- Lista completa -->
        <ul class="productos-lista" *ngIf="v._verMas">
          <li *ngFor="let d of ($any(v.pedido).detalles_pedidos || [])">
            <span class="qty">{{ $any(d).cantidad }}x</span>
            <span class="name">{{ $any(d).producto?.nombre }}</span>
            <span class="sub">{{ $any(d).subtotal | currency:'MXN':'symbol-narrow' }}</span>
          </li>
        </ul>
      </div>

      <div class="venta-acciones">
        <ion-button class="btn-detalle" size="small" (click)="irADetalle(v)">
          Ver detalles
        </ion-button>
      </div>
    </div>
  </div>

  <ng-template #sinVentas>
    <div class="mensaje-vacio">
      <ion-text color="medium">
        <p class="ion-text-center">No hay ventas con los filtros seleccionados.</p>
      </ion-text>
    </div>
  </ng-template>
</ion-content>
